# nanopore Data Notes

# Overview 
 	# Items to review before starting 
 	# Quality Control
 	# Adaptors / Trimming
 	# Assembly 
 	
----------------------------------------------------------------------------------------
# ITEMS TO REVIEW

# nanopore reference: https://community.nanoporetech.com/info_sheets/community-developed-data-a/v/dai_s1009_v1_revf_10oct2016

# It is important that things are in the right path. If applications aren't in the root path, you can add it or you will need to call it from the path.

echo #PATH # This command will show everything in the root path
export PATH=$PATH:MY/Path # To add to path 

# Conda (to avoid tricky path requirements)
	# Environments matter... 
conda info --envs # to look at environments
source activate py27 # to activate environment 
	# Most programs are avaible to install in conda
conda install desired.package # best to good desired package 


install_name_tool -change libcrypto.1.0.0.dylib $/Users/ncgrp/anaconda2/lib/libcrypto.1.1.dylib
sudo cp libssl.1.1.dylib libcrypto.1.1.dylib /usr/lib/ 
sudo rm libssl.1.1.dylib libcrypto.1.1.dylib 
sudo ln -s libssl.1.1.dylib libssl.dylib 
sudo ln -s libssl.1.1.dylib libcrypto.dylib

------
# RESOURCES
	# Physalis genome / Trascriptome : ftp://ftp.solgenomics.net/genomes/Physalis_pruinosa/
	# Annotated Pepper genome: http://peppersequence.genomics.cn/page/species/download.jsp
	
------------------------------------------------------------------------------------------

# ADAPTORS / TRIMMING

# Porechop
# Website: https://github.com/rrwick/Porechop 
	# Note: The author is no longer updating the program as of Oct. 2018
	
# Installing this was a little troublesome. Below is the code that was used for the installation (there was several to choose from)
git clone https://github.com/rrwick/Porechop.git
cd Porechop
make
./porechop-runner.py -h

# To demultiplex barcodes for a single file
./porechop-runner.py -i input-file -b output_dir

# This will demultiplex barcodes with a whole directory 
./porechop-runner.py -i /Users/ncgrp/Desktop/Nov30Nanopore/fastq/pass -b outputMult_dir

-----------------------
# Results from Nov. 30th Run:

Barcode  Reads   Bases       File           				Tissue          
  BC01      4,810   3,688,633  outputMult_dir/BC01.fastq 	Leaf
  BC02         35      32,105  outputMult_dir/BC02.fastq	corolla
  BC03      1,562   1,465,006  outputMult_dir/BC03.fastq	fruit
  BC04     41,858  36,205,635  outputMult_dir/BC04.fastq	DeNM13 style
  BC05        103     110,664  outputMult_dir/BC05.fastq	Pphil style
  BC06      2,466   1,837,464  outputMult_dir/BC06.fastq	CP44_3 style
  BC07      1,466     980,153  outputMult_dir/BC07.fastq	CP47_3 Style
  BC08      3,860   3,507,231  outputMult_dir/BC08.fastq	DeNM_14 Style
  BC09        937     659,001  outputMult_dir/BC09.fastq	Pperu1 Sytle
  none      1,801   1,483,025  outputMult_dir/none.fastq
# There was low coverage on several samples. This could have been do the pooling since before all sample where around the same concretion.

----------------------------------------------------------------------------------------
# ASSEMBLY  
	# Tophat
	# Kallisto
	# BWA
	# Canu (not as relevant) 

---------------
# Convert fastq to fasta 
cat BC09.fastq | awk '{if(NR%4==1) {printf(">%s\n",substr($0,2));} else if(NR%4==2) print;}' > Pperu1RNAnov30.fasta
	# Input file = BC09.fastq  output file = Pperu1RNAnov30.fasta

----------------
# BWA 
	# Install: https://sourceforge.net/projects/bio-bwa/files/
	# Manuel: http://bio-bwa.sourceforge.net/bwa.shtml

# This requires a reference genome / transcriptome 
	# I started with adding the Physalis pruniosa genome
bwa index /Users/ncgrp/Desktop/Physalis-pruinosa-genome_v1.fa 

# Alignment of the genome
bwa mem /Users/ncgrp/Desktop/Physalis-pruinosa-genome_v1.fa /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/BC01.fastq > /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30.sam 

## Move to samtools 
	# samtools didn't work in conda so I just downloaded the program directly to the computer

# convert .sam to .bam
samtools view -S -b /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30.sam > /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30.bam 
samtools view /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30.bam | head

samtools sort /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30.bam -o /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30_sorted.bam
samtools view /Users/ncgrp/Desktop/Nov30Nanopore/DemultiplexedReads/leafRNAnov30_sorted.bam | head

samtools view leafRNAnov30_sorted.bam | wc -l
	# leafRNA total number of alignments:  12516

# testing for "proper pairs"
samtools view -F 0x2 leafRNAnov30_sorted.bam | wc -l # looks for not proper pairs 
	# not proper pair: 12516 (all of them) 


# View alignment
	# I didn't get to this...

----------------
# I decided it would be best to make it to an annotated genome. 
bwa index Resources/5.v2.0_Zunla-1_genes_sequence.fa # index pepper gene 

bwa index Resources/5.v2.0_Zunla-1_genes_sequence.fa
bwa aln Resources/5.v2.0_Zunla-1_genes_sequence.fa BC04.fastq > DeNM_13Style.sai 
bwa samse Resources/5.v2.0_Zunla-1_genes_sequence.fa DeNM_14Style.sai  BC04.fastq > DeNM_13Style.sam 

-- # Move to terminal that can handle samtools
samtools faidx Resources/5.v2.0_Zunla-1_genes_sequence.fa

samtools view -S -b DeNM_13Style.sam > DeNM_13Style.bam 
samtools sort DeNM_13Style.bam -o DeNM_13Style_sorted.bam 



----------------
# Tophat 
	# This program is better for small reads, but right now I think all my reads are small reads...
	# Tophat (alignment of reference genome) -> cufflinks (map RNA reads) -> cuffmerge (will create one single transcriptome annotation) -> cuffdiff (using a ref. genome quantifies difference)  -> cummeRbund (visualize)
# Note: Installing this was a challenge since there are many different dependents  

# Quantification without a reference
tophat -p 8 -o 

tophat2 -o leaf_THout -p 8 /Users/ncgrp/Desktop/Physalis-pruinosa-genome_v1.fa BC01.fastq 

tophat -p4 -G Resources/Capsicum.annuum.L_Zunla-1_v2.0_cdna.gff -o tophat_results Resources/5.v2.0_Zunla-1_genes_sequence.fa.sa leaf_THout BC01.fastq

cuffdiff Resources/C_annumm.gtf leaf.sam CP44_3Style.sam CP47_3Style.sam DeNM_13Style.sam DeNM_14Style.sam 

---------------
# Code to change .gff file to .gtf
	# before I ran this code, I did change "mRNA" to "Transcript" in the document
gffread -E Capsicum.annuum.L_Zunla-1_v2.0_cdna.gff -T -o C_annumm.gtf


----------------
# Blast

# Convert fasta to wrapped files 
awk '/^>/ {printf("\n%s\n",$0);next; } { printf("%s",$0);}  END {printf("\n");}' < file.fa > file_unwrapped.fa

# Upload index file
makeblastdb -in Resources/5.v2.0_Zunla-1_genes_sequence.fa -dbtype nucl -out MyCapRNA

# running blast 
blastn -db MyCapRNA -query DeNM13styleRNAnov30_unwrapped.fasta > DeNM13_query.hits

blastn -db PprunRNA -query DeNM13styleRNAnov30_unwrapped.fasta > DeNM13_Pprun_query.hits

grep -v "#" DeNM13_query.hits | awk '{print $2}' > DeNM13_hit_IDs



----------------
# Kallisto
	# Website: https://pachterlab.github.io/kallisto/about

# I need to review more but this looks like it might be best for humans, also might be best for the hip computer kids :\


----------------
# Canu -- Better with DNA (I will try other programs before I move on to this one) 
# Website: https://github.com/marbl/canu

# Practice
curl -L -o oxford.fasta http://nanopore.s3.climb.ac.uk/MAP006-PCR-1_2D_pass.fasta

./bin/canu \
-p ecoli -d ecoli-oxford \
 genomeSize=4.8m \
 -nanopore-raw oxford.fasta

----
canu [-correct | -trim | -assemble | -trim-assemble] \
  [-s <assembly-specifications-file>] \
   -p <assembly-prefix> \
   -d <assembly-directory> \
   genomeSize=<number>[g|m|k] \
   [other-options] \
   [-pacbio-raw | -pacbio-corrected | -nanopore-raw | -nanopore-corrected] *fastq
   
   
--------------------------
## Scotty Power Analysis
	# http://scotty.genetics.utah.edu/help.html#GeneratingPilotData    
